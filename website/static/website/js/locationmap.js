// Generated by CoffeeScript 1.6.3
(function() {
  var LocationMap,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  LocationMap = (function(_super) {
    __extends(LocationMap, _super);

    function LocationMap(mapDiv) {
      this.focusName = "Aotea Centre";
      this.mapCentre = {
        lat: -36.851951,
        lng: 174.762256
      };
      this.focusLocation = {
        lat: -36.851951,
        lng: 174.762256
      };
      this.focusAddress = "50 Mayoral Drive, Auckland";
      google.maps.Map.apply(this, [mapDiv, this.mapOpts()]);
      this.addMarker();
      this.addCustomControls();
    }

    LocationMap.prototype.mapOpts = function() {
      return {
        center: this.mapCentre,
        zoom: 14,
        scrollwheel: false,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
          mapTypeIds: [google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.SATELLITE]
        },
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        styles: [
          {
            featureType: "road",
            elementType: "geometry",
            stylers: [
              {
                color: "#d1d1b8"
              }
            ]
          }, {
            featureType: "road",
            elementType: "labels.icon",
            stylers: [
              {
                visibility: "off"
              }
            ]
          }, {
            featureType: "road.highway",
            elementType: "labels.text.fill",
            stylers: [
              {
                color: "#585141"
              }
            ]
          }, {
            featureType: "road.highway",
            elementType: "geometry",
            stylers: [
              {
                color: "#bebea8"
              }
            ]
          }, {
            featureType: "road.highway.controlled_access",
            elementType: "geometry",
            stylers: [
              {
                color: "#f1d980"
              }
            ]
          }, {
            featureType: "transit",
            elementType: "all",
            stylers: [
              {
                visibility: "on"
              }
            ]
          }, {
            featureType: "water",
            elementType: "geometry",
            stylers: [
              {
                color: "#c6e2ff"
              }
            ]
          }, {
            featureType: "poi",
            elementType: "all",
            stylers: [
              {
                visibility: "off"
              }
            ]
          }, {
            featureType: "poi.park",
            elementType: "all",
            stylers: [
              {
                visibility: "on"
              }
            ]
          }, {
            featureType: "poi.school",
            elementType: "all",
            stylers: [
              {
                visibility: "on"
              }
            ]
          }, {
            featureType: "poi",
            elementType: "geometry.fill",
            stylers: [
              {
                color: "#c5e3bf"
              }
            ]
          }, {
            featureType: "administrative.locality",
            elementType: "labels.text",
            stylers: [
              {
                color: "#a22222"
              }
            ]
          }, {
            featureType: "all",
            elementType: "labels.text.stroke",
            stylers: [
              {
                visibility: "off"
              }
            ]
          }
        ]
      };
    };

    LocationMap.prototype.addMarker = function() {
      var infowindow, marker,
        _this = this;
      marker = new google.maps.Marker({
        title: this.focusName,
        position: this.focusLocation,
        map: this
      });
      infowindow = new google.maps.InfoWindow({
        content: $("#map-focusinfo-src").html()
      });
      infowindow.open(this, marker);
      google.maps.event.addListener(marker, 'click', function() {
        return infowindow.open(_this, marker);
      });
    };

    LocationMap.prototype.addCustomControls = function() {
      var RIGHT_CENTER, TOP_RIGHT, customControls, dayName, daynum, getdir, mapdir, origin, steps, transitTime, yyyymmdd, _i,
        _this = this;
      TOP_RIGHT = google.maps.ControlPosition.TOP_RIGHT;
      RIGHT_CENTER = google.maps.ControlPosition.RIGHT_CENTER;
      customControls = $('<div id="map-controls" />');
      customControls.css({
        padding: "5px",
        textAlign: "center",
        color: "black"
      });
      getdir = $('<div id="get-directions" />');
      getdir.css({
        padding: "1px 5px",
        marginLeft: "5px",
        background: "white",
        display: "inline-block",
        border: "1px solid black",
        cursor: "pointer",
        title: "Get directions to " + this.focusName + " from an address"
      });
      getdir.text("Get Directions");
      customControls.append(getdir);
      this.controls[TOP_RIGHT].push(customControls[0]);
      mapdir = $("#map-directions");
      mapdir.hide();
      getdir.click(function() {
        if (mapdir.is(":hidden")) {
          mapdir.show();
          return _this.controls[RIGHT_CENTER].push(mapdir[0]);
        }
      });
      $("#transit-time-option").change(function() {
        return _this.giveDirections();
      });
      transitTime = moment();
      $("#transit-time").val(transitTime.format("h:mm a"));
      yyyymmdd = transitTime.format("YYYY-MM-DD");
      $("#transit-date").append($("<option value=\"" + yyyymmdd + "\">Today</option>"));
      $("#transit-time").change(function() {
        return _this.giveDirections();
      });
      for (daynum = _i = 1; _i < 7; daynum = ++_i) {
        transitTime.add(1, "day");
        yyyymmdd = transitTime.format("YYYY-MM-DD");
        dayName = transitTime.format("D MMM, ddd");
        $("#transit-date").append($("<option value=\"" + yyyymmdd + "\">" + dayName + "</option>"));
      }
      $("#transit-date").change(function() {
        return _this.giveDirections();
      });
      origin = $('#map-directions-origin');
      origin.val("");
      steps = $("#map-directions-steps");
      this.autocomplete = new google.maps.places.Autocomplete(origin[0], {
        componentRestrictions: {
          country: "nz"
        }
      });
      this.autocomplete.bindTo('bounds', this);
      this.dirService = new google.maps.DirectionsService();
      this.dirDisplay = new google.maps.DirectionsRenderer({
        panel: steps[0],
        preserveViewport: true
      });
      $("#map-directions .close").click(function() {
        $("#transit-time").val(moment().format("h:mm a"));
        origin.val("");
        mapdir.hide();
        steps.empty();
        _this.dirDisplay.setMap(null);
        return _this.controls[RIGHT_CENTER].pop();
      });
      $(".travel-mode").click(function(ev) {
        var selectedIcon;
        selectedIcon = $(".selected-travel-mode");
        if (selectedIcon[0] !== ev.target) {
          if ($(ev.target).hasClass("travel-by-transit")) {
            $(".transit-options").show();
          } else {
            $(".transit-options").hide();
          }
          if (selectedIcon != null) {
            selectedIcon.removeClass("selected-travel-mode");
          }
          $(ev.target).addClass("selected-travel-mode");
          return _this.giveDirections();
        }
      });
      google.maps.event.addListener(this.autocomplete, 'place_changed', function() {
        return _this.giveDirections();
      });
    };

    LocationMap.prototype.giveDirections = function() {
      var place, routeOpts, selectedIcon, transitOpts, transitTime, transitTimeOption,
        _this = this;
      if ($('#map-directions-origin').val() === "") {
        return;
      }
      selectedIcon = $(".selected-travel-mode");
      place = this.autocomplete.getPlace();
      if (!place.geometry) {
        return;
      }
      transitOpts = null;
      routeOpts = {
        origin: place.geometry.location,
        destination: this.focusAddress
      };
      if (selectedIcon.hasClass("travel-by-transit")) {
        routeOpts['travelMode'] = google.maps.TravelMode.TRANSIT;
        transitTimeOption = $("#transit-time-option").val();
        transitTime = moment($("#transit-date").val() + " " + $("#transit-time").val(), ["YYYY-MM-DD h:mm a", "YYYY-MM-DD h:mma", "YYYY-MM-DD ha", "YYYY-MM-DD h:m:sa", "YYYY-MM-DD HH:mm", "YYYY-MM-DD HH:mm:s", "YYYY-MM-DD h"]);
        transitOpts = {};
        transitOpts[transitTimeOption] = transitTime.toDate();
        routeOpts['transitOptions'] = transitOpts;
      } else if (selectedIcon.hasClass("travel-by-bicycle")) {
        routeOpts['travelMode'] = google.maps.TravelMode.BICYCLING;
      } else if (selectedIcon.hasClass("travel-by-foot")) {
        routeOpts['travelMode'] = google.maps.TravelMode.WALKING;
      } else {
        routeOpts['travelMode'] = google.maps.TravelMode.DRIVING;
      }
      this.dirService.route(routeOpts, function(response, status) {
        if (status === google.maps.DirectionsStatus.OK) {
          _this.dirDisplay.setMap(_this);
          _this.dirDisplay.setDirections(response);
          _this.getDiv().scrollIntoView();
        }
      });
    };

    return LocationMap;

  })(google.maps.Map);

  $(function() {
    var locationMap;
    locationMap = $('#location-map');
    if (locationMap.length) {
      new LocationMap(locationMap[0]);
      $('header .address').wrap('<a id="location-link" href="#location"></a>');
    }
  });

}).call(this);
